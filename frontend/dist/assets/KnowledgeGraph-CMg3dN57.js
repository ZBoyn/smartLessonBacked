import{_ as oe,u as ae,r as v,c as G,l as se,y as ne,j as g,o as m,f as n,e as t,h as u,w as l,b as i,E as y,d as de,s as re,z as Q,A as ie,g as ue,q as pe,t as S,B as ce,F as $,m as M,a as P}from"./index-BotqV5dR.js";import{g as U}from"./modules-CiYeg_KF.js";import{i as ve}from"./index-CiU0J0Xr.js";import"./request-BUaFPsLP.js";const me={class:"page-container"},fe={class:"page-header"},ge={class:"title-section"},_e={class:"actions"},ye={"element-loading-text":"正在构建图谱...",class:"chart-wrapper"},be={key:0,class:"empty-state"},Ie={key:0,class:"node-detail"},we={class:"node-desc"},Ve={class:"stats"},ke={class:"stat-item"},he={class:"stat-val"},Ee={class:"stat-item"},Ce={class:"stat-val"},Re={key:1,class:"no-selection"},Se={__name:"KnowledgeGraph",setup(xe){const j=ae(),O=de(),b=j.params.courseId,E=v(!1),_=v(!1),x=v(null);let p=null;const I=v({nodes:[],edges:[]}),f=v(null),w=v(!1),V=v(!1),c=v({label:"",description:""}),d=v({sourceId:null,targetId:null,type:"RELATED"}),C=G(()=>I.value?.nodes||[]),H=G(()=>C.value.length>0),R=async()=>{if(b){E.value=!0;try{const s=await U.getGraph(b);if(s){const e=(s.nodes||[]).map(a=>({id:String(a.kpId),name:a.name,value:a.kpId,symbolSize:40,category:0,description:a.description,questionCount:a.questionCount||0,draggable:!0})),r=(s.edges||[]).map(a=>({source:String(a.sourceKpId),target:String(a.targetKpId),value:a.relationType}));I.value={nodes:e,edges:r},L(e,r)}else I.value={nodes:[],edges:[]}}catch(s){console.error(s);const e=[{id:"1",name:"Java基础",symbolSize:50,category:0},{id:"2",name:"面向对象",symbolSize:40,category:1},{id:"3",name:"集合框架",symbolSize:40,category:1},{id:"4",name:"多线程",symbolSize:40,category:1}],r=[{source:"1",target:"2",value:"包含"},{source:"1",target:"3",value:"包含"},{source:"1",target:"4",value:"包含"}];I.value={nodes:e,edges:r},L(e,r),s.message?.includes("404")||y.warning("加载图谱失败，显示模拟数据")}finally{E.value=!1}}},L=(s,e)=>{if(!x.value)return;p&&p.dispose(),p=ve(x.value);const r={tooltip:{trigger:"item",formatter:"{b}"},legend:[{data:s.map(a=>a.category).filter((a,D,z)=>z.indexOf(a)===D)}],series:[{name:"Knowledge Graph",type:"graph",layout:"force",data:s,links:e,categories:[{name:"核心知识点"},{name:"子知识点"}],roam:!0,label:{show:!0,position:"bottom",formatter:"{b}",fontSize:12},lineStyle:{color:"source",curveness:.3},force:{repulsion:300,edgeLength:120},emphasis:{focus:"adjacency",lineStyle:{width:4}}}]};p.setOption(r),p.on("click",a=>{a.dataType==="node"&&(f.value=a.data)}),window.addEventListener("resize",T)},T=()=>{p&&p.resize()},J=async()=>{if(c.value.label){_.value=!0;try{await U.addNode({name:c.value.label,description:c.value.description,courseId:parseInt(b)}),y.success("知识点添加成功"),w.value=!1,c.value={label:"",description:""},R()}catch{y.error("添加失败")}finally{_.value=!1}}},W=async()=>{if(d.value.sourceId===d.value.targetId){y.warning("源节点和目标节点不能相同");return}if(!(!d.value.sourceId||!d.value.targetId)){_.value=!0;try{const s={INCLUDES:"belongs_to",PREREQUISITE:"prerequisite",RELATED:"explains"};await U.addRelation({sourceKpId:d.value.sourceId,targetKpId:d.value.targetId,relationType:s[d.value.type]||"belongs_to",courseId:parseInt(b)}),y.success("关系建立成功"),V.value=!1,d.value={sourceId:null,targetId:null,type:"RELATED"},R()}catch{y.error("操作失败")}finally{_.value=!1}}},X=s=>I.value.edges.filter(r=>r.source===s||r.target===s).length,Y=s=>{const e=C.value.find(r=>r.id===String(s));return e&&e.questionCount||0},Z=s=>{O.push({name:"SmartQuestions",params:{courseId:b},query:{kpId:s.id}})};return se(()=>{R()}),ne(()=>{window.removeEventListener("resize",T),p&&p.dispose()}),(s,e)=>{const r=i("el-icon"),a=i("el-button"),D=i("el-button-group"),z=i("el-empty"),q=i("el-card"),A=i("el-col"),ee=i("el-divider"),te=i("el-row"),K=i("el-input"),k=i("el-form-item"),B=i("el-form"),F=i("el-dialog"),h=i("el-option"),N=i("el-select"),le=re("loading");return m(),g("div",me,[n("div",fe,[n("div",ge,[n("h2",null,[t(r,{class:"icon-header"},{default:l(()=>[t(Q(ie))]),_:1}),e[12]||(e[12]=u(" 课程知识图谱",-1))]),e[13]||(e[13]=n("p",{class:"subtitle"},"可视化展示课程知识点关联结构",-1))]),n("div",_e,[t(D,null,{default:l(()=>[t(a,{icon:"Refresh",onClick:R},{default:l(()=>[...e[14]||(e[14]=[u("刷新",-1)])]),_:1}),t(a,{type:"primary",icon:"Plus",onClick:e[0]||(e[0]=o=>w.value=!0)},{default:l(()=>[...e[15]||(e[15]=[u("添加知识点",-1)])]),_:1}),t(a,{type:"success",icon:"Connection",onClick:e[1]||(e[1]=o=>V.value=!0)},{default:l(()=>[...e[16]||(e[16]=[u("建立关联",-1)])]),_:1})]),_:1})])]),t(te,{gutter:20},{default:l(()=>[t(A,{span:18},{default:l(()=>[t(q,{class:"graph-card",shadow:"hover"},{default:l(()=>[ue((m(),g("div",ye,[n("div",{id:"graph-chart",class:"chart-container",ref_key:"chartRef",ref:x},null,512),!H.value&&!E.value?(m(),g("div",be,[t(z,{description:"暂无图谱数据，请添加知识点"})])):pe("",!0)])),[[le,E.value]])]),_:1})]),_:1}),t(A,{span:6},{default:l(()=>[t(q,{class:"info-card",shadow:"hover"},{header:l(()=>[...e[17]||(e[17]=[n("div",{class:"card-header"},[n("span",null,"节点详情")],-1)])]),default:l(()=>[f.value?(m(),g("div",Ie,[n("h3",null,S(f.value.name),1),n("p",we,S(f.value.description||"暂无描述"),1),t(ee,null,{default:l(()=>[...e[18]||(e[18]=[u("关联统计",-1)])]),_:1}),n("div",Ve,[n("div",ke,[n("div",he,S(X(f.value.id)),1),e[19]||(e[19]=n("div",{class:"stat-label"},"关联数",-1))]),n("div",Ee,[n("div",Ce,S(Y(f.value.id)),1),e[20]||(e[20]=n("div",{class:"stat-label"},"题目数",-1))])]),t(a,{type:"primary",plain:"",style:{width:"100%","margin-top":"20px"},onClick:e[2]||(e[2]=o=>Z(f.value))},{default:l(()=>[...e[21]||(e[21]=[u("查看相关题目",-1)])]),_:1})])):(m(),g("div",Re,[t(r,{size:"48",color:"#dcdfe6"},{default:l(()=>[t(Q(ce))]),_:1}),e[22]||(e[22]=n("p",null,"点击图谱节点查看详情",-1))]))]),_:1})]),_:1})]),_:1}),t(F,{modelValue:w.value,"onUpdate:modelValue":e[6]||(e[6]=o=>w.value=o),title:"添加知识点",width:"450px","destroy-on-close":""},{footer:l(()=>[t(a,{onClick:e[5]||(e[5]=o=>w.value=!1)},{default:l(()=>[...e[23]||(e[23]=[u("取消",-1)])]),_:1}),t(a,{type:"primary",onClick:J,loading:_.value},{default:l(()=>[...e[24]||(e[24]=[u("确认添加",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(B,{model:c.value,"label-width":"80px",ref:"nodeFormRef"},{default:l(()=>[t(k,{label:"名称",required:""},{default:l(()=>[t(K,{modelValue:c.value.label,"onUpdate:modelValue":e[3]||(e[3]=o=>c.value.label=o),placeholder:"例如：HashMap原理"},null,8,["modelValue"])]),_:1}),t(k,{label:"描述"},{default:l(()=>[t(K,{modelValue:c.value.description,"onUpdate:modelValue":e[4]||(e[4]=o=>c.value.description=o),type:"textarea",rows:"3",placeholder:"简要描述该知识点..."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(F,{modelValue:V.value,"onUpdate:modelValue":e[11]||(e[11]=o=>V.value=o),title:"建立知识关联",width:"500px","destroy-on-close":""},{footer:l(()=>[t(a,{onClick:e[10]||(e[10]=o=>V.value=!1)},{default:l(()=>[...e[25]||(e[25]=[u("取消",-1)])]),_:1}),t(a,{type:"primary",onClick:W,loading:_.value},{default:l(()=>[...e[26]||(e[26]=[u("确认建立",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(B,{model:d.value,"label-width":"80px"},{default:l(()=>[t(k,{label:"源节点"},{default:l(()=>[t(N,{modelValue:d.value.sourceId,"onUpdate:modelValue":e[7]||(e[7]=o=>d.value.sourceId=o),placeholder:"选择起始知识点",style:{width:"100%"},filterable:""},{default:l(()=>[(m(!0),g($,null,M(C.value,o=>(m(),P(h,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(k,{label:"关系类型"},{default:l(()=>[t(N,{modelValue:d.value.type,"onUpdate:modelValue":e[8]||(e[8]=o=>d.value.type=o),placeholder:"选择关系类型",style:{width:"100%"}},{default:l(()=>[t(h,{label:"包含 (Includes)",value:"INCLUDES"}),t(h,{label:"前置 (Prerequisite)",value:"PREREQUISITE"}),t(h,{label:"相关 (Related)",value:"RELATED"})]),_:1},8,["modelValue"])]),_:1}),t(k,{label:"目标节点"},{default:l(()=>[t(N,{modelValue:d.value.targetId,"onUpdate:modelValue":e[9]||(e[9]=o=>d.value.targetId=o),placeholder:"选择指向知识点",style:{width:"100%"},filterable:""},{default:l(()=>[(m(!0),g($,null,M(C.value,o=>(m(),P(h,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Le=oe(Se,[["__scopeId","data-v-a0461206"]]);export{Le as default};
