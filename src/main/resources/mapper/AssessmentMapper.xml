<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.neu.smartLesson.mapper.AssessmentMapper">

    <resultMap id="AssessmentResultMap" type="com.neu.smartLesson.model.Assessment">
        <id property="assessmentId" column="assessment_id"/>
        <result property="classId" column="class_id"/>
        <result property="createdById" column="created_by_id"/>
        <result property="assessmentType" column="assessment_type"/>
        <result property="status" column="status"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
    </resultMap>

    <select id="findAssessmentsForStudent"
            parameterType="int"
            resultType="com.neu.smartLesson.dto.AssessmentDto">
        SELECT
            a.assessment_id AS assessmentId,
            a.title,
            a.assessment_type AS assessmentType,
            a.status,
            a.end_time AS endTime,

            CASE
                WHEN s.submission_id IS NOT NULL THEN s.status
                ELSE 'pending' END AS submissionStatus

        FROM
            Assessments a

                JOIN
            Enrollments e ON a.class_id = e.class_id

                LEFT JOIN
            Submissions s ON a.assessment_id = s.assessment_id AND e.student_id = s.student_id

        WHERE
            e.student_id = #{studentId}
          AND a.status = 'published' ORDER BY
            a.end_time ASC; </select>

    <insert id="insertAssessment" parameterType="com.neu.smartLesson.model.Assessment"
            useGeneratedKeys="true" keyProperty="assessmentId">
        INSERT INTO Assessments
            (class_id, title, assessment_type, status, created_by_id)
        VALUES
            (#{classId}, #{title}, #{assessmentType}, 'draft', #{createdById})
    </insert>

    <select id="findAssessmentById" parameterType="int" resultMap="AssessmentResultMap">
        SELECT * FROM Assessments WHERE assessment_id = #{assessmentId}
    </select>

    <update id="updateAssessmentStatus" parameterType="com.neu.smartLesson.model.Assessment">
        UPDATE Assessments
        SET
            status = #{status},
            start_time = #{startTime},
            end_time = #{endTime}
        WHERE
            assessment_id = #{assessmentId}
    </update>

</mapper>